<!DOCTYPE html>
<html>
<head>
    <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–∞</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #c82333; }
        .error { color: red; font-size: 14px; }
        .success { color: green; font-size: 14px; }
        .nav { margin-bottom: 20px; }
        .nav a { margin-right: 15px; text-decoration: none; color: #333; }
        .helptext { font-size: 12px; color: #666; margin-top: 5px; }
        #map { height: 300px; margin: 15px 0; border: 1px solid #ddd; border-radius: 4px; }
        .map-instructions { background: #e7f3ff; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <h2>üè¢ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–∞</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="{% if message.tags == 'error' %}error{% else %}success{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" id="registration-form">
        {% csrf_token %}

        <div class="map-instructions">
            <strong>üó∫Ô∏è –£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–∞:</strong>
            <p>–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –≤ –ø–æ–ª–µ –Ω–∏–∂–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞–º –Ω–∞–π—Ç–∏ –≤–∞—Å!</p>
        </div>

        {% for field in form %}
            {% if field.name != 'latitude' and field.name != 'longitude' %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}
                    <div class="helptext">{{ field.help_text }}</div>
                {% endif %}
                {% if field.errors %}
                    <div class="error">{{ field.errors }}</div>
                {% endif %}
            </div>
            {% endif %}
        {% endfor %}

        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
        {{ form.latitude }}
        {{ form.longitude }}

        <div id="map"></div>
        <div id="coordinates" style="margin: 10px 0; font-size: 14px; color: #666;">
            –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –Ω–µ —É–∫–∞–∑–∞–Ω—ã
        </div>

        <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å</button>
    </form>

    <p style="margin-top: 20px;">
        –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="{% url 'autoservices:login' %}">–í–æ–π—Ç–∏</a>
    </p>
    <p>
        –í—ã –∫–ª–∏–µ–Ω—Ç? <a href="{% url 'clients:register' %}">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∑–¥–µ—Å—å</a>
    </p>

    <script src="https://api-maps.yandex.ru/2.1/?apikey=265904e6-0ebe-4652-889e-0cc2d19bf270&lang=ru_RU" type="text/javascript"></script>
    <script>
        let map;
        let placemark;

        ymaps.ready(init);

        function init() {
            map = new ymaps.Map('map', {
                center: [55.76, 37.64],
                zoom: 10
            });

            // –ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É
            const addressInput = document.getElementById('address-input');
            addressInput.addEventListener('change', function() {
                geocodeAddress(this.value);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.events.add('click', function (e) {
                const coords = e.get('coords');

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
                document.getElementById('id_latitude').value = coords[0].toPrecision(6);
                document.getElementById('id_longitude').value = coords[1].toPrecision(6);

                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                document.getElementById('coordinates').textContent =
                    `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coords[0].toPrecision(6)}, ${coords[1].toPrecision(6)}`;

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Ç–∫—É
                if (placemark) {
                    map.geoObjects.remove(placemark);
                }

                placemark = new ymaps.Placemark(coords, {
                    balloonContent: '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–∞'
                }, {
                    preset: 'islands#redAutoIcon'
                });

                map.geoObjects.add(placemark);
                map.setCenter(coords, 15);
            });
        }

        function geocodeAddress(address) {
            ymaps.geocode(address).then(function (res) {
                const firstGeoObject = res.geoObjects.get(0);
                const coords = firstGeoObject.geometry.getCoordinates();

                map.setCenter(coords, 15);

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Ç–∫—É
                if (placemark) {
                    map.geoObjects.remove(placemark);
                }

                placemark = new ymaps.Placemark(coords, {
                    balloonContent: firstGeoObject.getAddress()
                }, {
                    preset: 'islands#redAutoIcon'
                });

                map.geoObjects.add(placemark);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                document.getElementById('id_latitude').value = coords[0].toPrecision(6);
                document.getElementById('id_longitude').value = coords[1].toPrecision(6);
                document.getElementById('coordinates').textContent =
                    `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coords[0].toPrecision(6)}, ${coords[1].toPrecision(6)}`;
            });
        }
    </script>
</body>
</html>