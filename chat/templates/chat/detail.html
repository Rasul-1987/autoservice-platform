{% extends 'base.html' %}
{% load static %}

{% block title %}–ß–∞—Ç —Å {{ interlocutor.username }}{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e9ecef;">
        <div>
            <h1 style="margin: 0 0 5px 0; color: #333; font-size: 24px;">
                {% if user_type == 'client' %}
                    üè¢ –ß–∞—Ç —Å –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–æ–º: {{ interlocutor.username }}
                {% else %}
                    üë§ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º: {{ interlocutor.username }}
                {% endif %}
            </h1>
            {% if chat_room.repair_request %}
                <div style="color: #666; font-size: 14px;">
                    üìã –ü–æ –∑–∞—è–≤–∫–µ: {{ chat_room.repair_request.title }}
                </div>
            {% endif %}
        </div>
        <a href="{% url 'chat:chat_list' %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —á–∞—Ç–∞–º</a>
    </div>

    <div id="chat-messages"
         style="height: 500px; overflow-y: auto; padding: 20px;
                background: #f8f9fa; border-radius: 10px; margin-bottom: 20px;
                display: flex; flex-direction: column; gap: 10px;">

        {% for message in messages %}
        <div style="max-width: 70%; padding: 12px 16px; border-radius: 15px;
                   {% if message.sender == user %}
                       align-self: flex-end;
                       background: #667eea;
                       color: white;
                       border-bottom-right-radius: 5px;
                   {% else %}
                       align-self: flex-start;
                       background: white;
                       color: #333;
                       border-bottom-left-radius: 5px;
                       border: 1px solid #e9ecef;
                   {% endif %}">
            <div style="font-size: 14px; margin-bottom: 5px;
                       {% if message.sender == user %}color: rgba(255,255,255,0.9){% endif %}">
                {% if message.sender == user %}
                    ‚úçÔ∏è –í—ã
                {% else %}
                    {% if message.is_sender_client %}
                        üë§ –ö–ª–∏–µ–Ω—Ç
                    {% else %}
                        üè¢ –ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å
                    {% endif %}
                {% endif %}
                <span style="font-size: 11px; opacity: 0.8; margin-left: 10px;">
                    {{ message.timestamp|date:"H:i" }}
                </span>
            </div>
            <div>{{ message.content }}</div>
        </div>
        {% endfor %}
    </div>

    <form id="message-form" method="post" action="{% url 'chat:send_message' chat_room.id %}"
          style="display: flex; gap: 10px;">
        {% csrf_token %}
        <input type="text" name="content" id="message-input"
               placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
               style="flex: 1; padding: 12px 15px; border: 1px solid #ddd;
                      border-radius: 25px; font-size: 16px; outline: none;
                      transition: border-color 0.3s;">
        <button type="submit" class="btn btn-primary" style="padding: 12px 25px;">
            üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        </button>
    </form>
</div>

<script>
    // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã AJAX
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const form = this;
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();

        if (!message) return;

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = 'max-width: 70%; padding: 12px 16px; border-radius: 15px; align-self: flex-end; background: #667eea; color: white; border-bottom-right-radius: 5px;';
                messageDiv.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 5px; color: rgba(255,255,255,0.9);">
                        ‚úçÔ∏è –í—ã
                        <span style="font-size: 11px; opacity: 0.8; margin-left: 10px;">${data.timestamp}</span>
                    </div>
                    <div>${data.content}</div>
                `;
                chatMessages.appendChild(messageDiv);

                // –û–±–Ω–æ–≤–ª—è–µ–º lastMessageId
                lastMessageId = data.message_id;

                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                messageInput.value = '';

                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                if (data.total_unread !== undefined) {
                    updateNotificationBadge(data.total_unread);
                }
            }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    let lastMessageId = {{ last_message_id|default:0 }};

    function checkNewMessages() {
        if (lastMessageId) {
            fetch(`/chat/{{ chat_room.id }}/get-new/${lastMessageId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            const messageDiv = document.createElement('div');

                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å (–∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å)
                            let senderIcon = '';
                            let senderName = '';
                            let isOwnMessage = msg.is_own;

                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –ø–æ –∏–º–µ–Ω–∏ (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
                            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –ª—É—á—à–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–∏–ø –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞
                            if (msg.is_own) {
                                senderIcon = '‚úçÔ∏è';
                                senderName = '–í—ã';
                            } else {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ user_type, –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
                                {% if user_type == 'client' %}
                                    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∫–ª–∏–µ–Ω—Ç, —Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å - –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å
                                    senderIcon = 'üè¢';
                                    senderName = '–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å';
                                {% else %}
                                    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å, —Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å - –∫–ª–∏–µ–Ω—Ç
                                    senderIcon = 'üë§';
                                    senderName = '–ö–ª–∏–µ–Ω—Ç';
                                {% endif %}
                            }

                            messageDiv.style.cssText = isOwnMessage ?
                                'max-width: 70%; padding: 12px 16px; border-radius: 15px; align-self: flex-end; background: #667eea; color: white; border-bottom-right-radius: 5px;' :
                                'max-width: 70%; padding: 12px 16px; border-radius: 15px; align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 5px; border: 1px solid #e9ecef;';

                            messageDiv.innerHTML = `
                                <div style="font-size: 14px; margin-bottom: 5px; ${isOwnMessage ? 'color: rgba(255,255,255,0.9);' : ''}">
                                    ${senderIcon} ${senderName}
                                    <span style="font-size: 11px; opacity: 0.8; margin-left: 10px;">${msg.timestamp}</span>
                                </div>
                                <div>${msg.content}</div>
                            `;
                            chatMessages.appendChild(messageDiv);

                            lastMessageId = Math.max(lastMessageId, msg.id);
                        });

                        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                });
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(checkNewMessages, 5000);
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ lastMessageId > 0)
    if (lastMessageId > 0) {
        setTimeout(checkNewMessages, 5000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–π–¥–∂–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function updateNotificationBadge(count) {
        let badge = document.querySelector('.notification-badge');
        let link = document.querySelector('a[href="{% url 'chat:chat_list' %}"]');

        if (count > 0) {
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'notification-badge';
                link.appendChild(badge);
            }
            badge.textContent = count;
        } else if (badge) {
            badge.remove();
        }
}
</script>
{% endblock %}