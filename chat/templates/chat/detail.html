{% extends 'base.html' %}
{% load static %}

{% block title %}Чат с {{ interlocutor.username }}{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e9ecef;">
        <div>
            <h1 style="margin: 0 0 5px 0; color: #333; font-size: 24px;">
                {% if user_type == 'client' %}
                    🏢 Чат с автосервисом: {{ interlocutor.username }}
                {% else %}
                    👤 Чат с клиентом: {{ interlocutor.username }}
                {% endif %}
            </h1>
            {% if chat_room.repair_request %}
                <div style="color: #666; font-size: 14px;">
                    📋 По заявке: {{ chat_room.repair_request.title }}
                </div>
            {% endif %}
        </div>
        <a href="{% url 'chat:chat_list' %}" class="btn btn-secondary">← Назад к чатам</a>
    </div>

    <div id="chat-messages" 
         style="height: 500px; overflow-y: auto; padding: 20px; 
                background: #f8f9fa; border-radius: 10px; margin-bottom: 20px;
                display: flex; flex-direction: column; gap: 10px;">
        
        {% for message in messages %}
        <div style="max-width: 70%; padding: 12px 16px; border-radius: 15px;
                   {% if message.sender == user %}
                       align-self: flex-end;
                       background: #667eea;
                       color: white;
                       border-bottom-right-radius: 5px;
                   {% else %}
                       align-self: flex-start;
                       background: white;
                       color: #333;
                       border-bottom-left-radius: 5px;
                       border: 1px solid #e9ecef;
                   {% endif %}">
            <div style="font-size: 14px; margin-bottom: 5px; 
                       {% if message.sender == user %}color: rgba(255,255,255,0.9){% endif %}">
                {% if message.sender == user %}
                    ✍️ Вы
                {% else %}
                    {% if message.is_sender_client %}
                        👤 Клиент
                    {% else %}
                        🏢 Автосервис
                    {% endif %}
                {% endif %}
                <span style="font-size: 11px; opacity: 0.8; margin-left: 10px;">
                    {{ message.timestamp|date:"H:i" }}
                </span>
            </div>
            <div>{{ message.content }}</div>
        </div>
        {% endfor %}
    </div>

    <form id="message-form" method="post" action="{% url 'chat:send_message' chat_room.id %}"
          style="display: flex; gap: 10px;">
        {% csrf_token %}
        <input type="text" name="content" id="message-input" 
               placeholder="Введите сообщение..." 
               style="flex: 1; padding: 12px 15px; border: 1px solid #ddd; 
                      border-radius: 25px; font-size: 16px; outline: none;
                      transition: border-color 0.3s;">
        <button type="submit" class="btn btn-primary" style="padding: 12px 25px;">
            📨 Отправить
        </button>
    </form>
</div>

<script>
    // Автопрокрутка к последнему сообщению
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
</script>
{% endblock %}