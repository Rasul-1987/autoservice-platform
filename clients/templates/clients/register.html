
{#{% if form.non_field_errors %}#}
{#    <div style="color: red; background: #ffeaea; padding: 10px; border-radius: 4px; margin-bottom: 15px;">#}
{#        {% for error in form.non_field_errors %}#}
{#            {{ error }}<br>#}
{#        {% endfor %}#}
{#    </div>#}
{#{% endif %}#}


{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ - AutoService{% endblock %}

{% block content %}
<div class="card">
    <h1>üë§ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞</h1>
    
    <form method="post" id="registrationForm">
        {% csrf_token %}
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                
                <div style="margin-bottom: 15px;">
                    <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *:</label>
                    {{ form.username }}
                    {% if form.username.errors %}
                        <div style="color: red; font-size: 14px;">{{ form.username.errors }}</div>
                    {% endif %}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>–ü–∞—Ä–æ–ª—å *:</label>
                    {{ form.password1 }}
                    {% if form.password1.errors %}
                        <div style="color: red; font-size: 14px;">{{ form.password1.errors }}</div>
                    {% endif %}
                </div>

                <div style="margin-bottom: 15px;">
                    <label>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è *:</label>
                    {{ form.password2 }}
                    {% if form.password2.errors %}
                        <div style="color: red; font-size: 14px;">{{ form.password2.errors }}</div>
                    {% endif %}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω *:</label>
                    {{ form.phone }}
                    {% if form.phone.errors %}
                        <div style="color: red; font-size: 14px;">{{ form.phone.errors }}</div>
                    {% endif %}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>Email *:</label>
                    {{ form.email }}
                    {% if form.email.errors %}
                        <div style="color: red; font-size: 14px;">{{ form.email.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div>
                <h3>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</h3>
                
                <div style="margin-bottom: 15px;">
                    <label>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ *:</label>
                    {{ form.location }}
                    <small style="color: #666;">–ê–¥—Ä–µ—Å –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</small>
                </div>
                
                <div style="background: #e9f7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0;">üìç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è</h4>
                    <button type="button" id="getLocationBtn" class="btn btn-primary" style="margin-bottom: 10px;">
                        üéØ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                    </button>
                    <div id="locationStatus" style="font-size: 14px; color: #666;">
                        –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                    </div>
                </div>
                
                <!-- –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è -->
                <div id="map" style="height: 200px; width: 100%; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px; display: none;"></div>
                
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</h3>
                
                <div style="margin-bottom: 10px;">
                    <label>–ú–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                    {{ form.car_brand }}
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label>–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                    {{ form.car_model }}
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label>–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞:</label>
                    {{ form.car_year }}
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label>VIN –∫–æ–¥:</label>
                    {{ form.car_vin }}
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label>–ì–æ—Å–Ω–æ–º–µ—Ä:</label>
                    {{ form.car_license_plate }}
                </div>
            </div>
        </div>
        
        <div style="border-top: 1px solid #eee; padding-top: 20px;">
            <button type="submit" class="btn btn-primary">üë§ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <a href="{% url 'home' %}" class="btn btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º API –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç -->
<script src="https://api-maps.yandex.ru/2.1/?apikey=265904e6-0ebe-4652-889e-0cc2d19bf270&lang=ru_RU" type="text/javascript"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const getLocationBtn = document.getElementById('getLocationBtn');
    const locationStatus = document.getElementById('locationStatus');
    const locationField = document.getElementById('id_location');
    const mapContainer = document.getElementById('map');
    
    let map, placemark;

    function updateLocationStatus(message, isError = false) {
        locationStatus.innerHTML = message;
        locationStatus.style.color = isError ? '#dc3545' : '#28a745';
    }

    function initMap(center) {
        if (!map) {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
            ymaps.ready(function() {
                map = new ymaps.Map('map', {
                    center: center,
                    zoom: 15,
                    controls: ['zoomControl', 'typeSelector']
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É
                placemark = new ymaps.Placemark(center, {}, {
                    preset: 'islands#blueAutoIcon',
                    draggable: true
                });
                
                map.geoObjects.add(placemark);
                
                // –ü—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –º–µ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å
                placemark.events.add('dragend', function () {
                    const coords = placemark.geometry.getCoordinates();
                    getAddressByCoords(coords);
                });
                
                // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç—É –ø–µ—Ä–µ–º–µ—â–∞–µ–º –º–µ—Ç–∫—É
                map.events.add('click', function (e) {
                    const coords = e.get('coords');
                    placemark.geometry.setCoordinates(coords);
                    getAddressByCoords(coords);
                });
            });
        } else {
            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º —Ü–µ–Ω—Ç—Ä
            map.setCenter(center);
            placemark.geometry.setCoordinates(center);
        }
        
        mapContainer.style.display = 'block';
    }

    function getAddressByCoords(coords) {
        ymaps.geocode(coords).then(function (res) {
            const firstGeoObject = res.geoObjects.get(0);
            const address = firstGeoObject.getAddressLine();
            
            locationField.value = address;
            updateLocationStatus(`‚úÖ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: ${address}`);
        });
    }

    function getCurrentLocation() {
        updateLocationStatus('üîÑ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...');
        
        if (!navigator.geolocation) {
            updateLocationStatus('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é', true);
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const coords = [lat, lng];
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É —Å —Ç–µ–∫—É—â–∏–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                initMap(coords);
                
                // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                getAddressByCoords(coords);
            },
            function(error) {
                let errorMessage = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = '‚ùå –î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = '‚ùå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                        break;
                    case error.TIMEOUT:
                        errorMessage = '‚ùå –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ';
                        break;
                }
                
                updateLocationStatus(errorMessage, true);
                
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ –ú–æ—Å–∫–≤–µ
                initMap([55.7558, 37.6173]);
                updateLocationStatus('üìç –£–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }

    getLocationBtn.addEventListener('click', getCurrentLocation);

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤–≤–æ–¥–µ –∞–¥—Ä–µ—Å–∞
    let suggestTimeout;
    locationField.addEventListener('input', function() {
        clearTimeout(suggestTimeout);
        
        if (this.value.length > 2) {
            suggestTimeout = setTimeout(() => {
                updateLocationStatus('üîÑ –ò—â–µ–º –∞–¥—Ä–µ—Å...');
                
                ymaps.suggest(this.value).then(function(items) {
                    if (items && items.length > 0) {
                        updateLocationStatus('‚úÖ –í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö');
                        
                        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
                        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
                        ymaps.geocode(items[0].value).then(function(res) {
                            const firstGeoObject = res.geoObjects.get(0);
                            const coords = firstGeoObject.geometry.getCoordinates();
                            
                            if (map) {
                                map.setCenter(coords);
                                if (placemark) {
                                    placemark.geometry.setCoordinates(coords);
                                }
                            } else {
                                initMap(coords);
                            }
                        });
                    }
                });
            }, 500);
        }
    });
});
</script>

<style>
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5a6fd8;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

form input, form select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 5px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç */
.ymaps-2-1-79-map {
    border-radius: 5px;
}
</style>
{% endblock %}