{% extends 'base.html' %}

{% block title %}–ö–∞—Ä—Ç–∞ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–æ–≤{% endblock %}

{% block content %}
<div style="position: relative; height: calc(100vh - 150px);">

    <div id="map" style="width: 100%; height: 100%;"></div>

    <div class="filters" style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
        <h3 style="margin-top: 0; margin-bottom: 10px;">üîß –§–∏–ª—å—Ç—Ä—ã</h3>
        <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">–¢–∏–ø –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:</label>
            <select id="verification-filter" style="width: 100%; padding: 5px;">
                <option value="all">–í—Å–µ</option>
                <option value="basic">–ë–∞–∑–æ–≤–∞—è</option>
                <option value="premium">–ü—Ä–µ–º–∏—É–º</option>
                <option value="verified">–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
            </select>
        </div>
        <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">–£—Å–ª—É–≥–∏:</label>
            <input type="text" id="services-filter" placeholder="–ü–æ–∏—Å–∫ –ø–æ —É—Å–ª—É–≥–∞–º..." style="width: 100%; padding: 5px;">
        </div>
        <button onclick="applyFilters()" style="width: 100%; padding: 8px; margin-bottom: 5px; background: #667eea; color: white; border: none; border-radius: 3px; cursor: pointer;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button onclick="resetFilters()" style="width: 100%; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">–°–±—Ä–æ—Å–∏—Ç—å</button>
        <button onclick="locateUser()" style="width: 100%; padding: 8px; margin-top: 10px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">üìç –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
    </div>
</div>

<script src="https://api-maps.yandex.ru/2.1/?apikey=–≤–∞—à_api_–∫–ª—é—á&lang=ru_RU" type="text/javascript"></script>
<script>
    let map;
    let objectManager;
    let allAutoservices = [];
    let userLocation = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    ymaps.ready(init);

    function init() {
        map = new ymaps.Map('map', {
            center: [55.76, 37.64], // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            zoom: 10
        });

        objectManager = new ymaps.ObjectManager({
            clusterize: true,
            gridSize: 32,
            clusterDisableClickZoom: true
        });

        objectManager.objects.options.set('preset', 'islands#blueAutoIcon');
        objectManager.clusters.options.set('preset', 'islands#blueClusterIcons');
        map.geoObjects.add(objectManager);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        locateUser();

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–æ–≤
        loadAutoservices();
    }

    function loadAutoservices() {
        // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å AJAX –∑–∞–ø—Ä–æ—Å –∫ –≤–∞—à–µ–º—É API
        // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        const testData = [
            {
                id: 1,
                name: "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å ‚Ññ1",
                services: "–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂, —Ä–µ–º–æ–Ω—Ç –¥–≤–∏–≥–∞—Ç–µ–ª—è",
                phone: "+7 (999) 123-45-67",
                address: "–ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 1",
                lat: 37.6173,
                lon: 55.7558,
                verification_type: "–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π",
                verification_color: "verified"
            },
            {
                id: 2,
                name: "–°–¢–û –ü—Ä–µ–º–∏—É–º",
                services: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –∫—É–∑–æ–≤–Ω–æ–π —Ä–µ–º–æ–Ω—Ç",
                phone: "+7 (999) 123-45-68",
                address: "–ú–æ—Å–∫–≤–∞, —É–ª. –¢–µ—Å—Ç–æ–≤–∞—è, 15",
                lat: 37.6178,
                lon: 55.7517,
                verification_type: "–ü—Ä–µ–º–∏—É–º",
                verification_color: "premium"
            }
        ];

        allAutoservices = testData;
        displayAutoservices(testData);
    }

    function displayAutoservices(autoservices) {
        const features = autoservices.map(service => ({
            type: 'Feature',
            id: service.id,
            geometry: {
                type: 'Point',
                coordinates: [service.lon, service.lat]
            },
            properties: {
                balloonContent: `
                    <div style="max-width: 250px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${service.name}</div>
                        <div style="margin: 5px 0;">üìû ${service.phone}</div>
                        <div style="margin: 5px 0;">üìç ${service.address}</div>
                        <div style="margin: 5px 0;">üîß ${service.services}</div>
                        <div style="margin: 5px 0;">
                            –°—Ç–∞—Ç—É—Å: ${service.verification_type}
                            <span style="display: inline-block; padding: 2px 8px; border-radius: 3px; color: white; font-size: 12px; margin-left: 5px; background: 
                                ${service.verification_color === 'basic' ? '#6c757d' : 
                                  service.verification_color === 'premium' ? '#007bff' : '#28a745'}">
                                ${service.verification_type}
                            </span>
                        </div>
                    </div>
                `,
                clusterCaption: service.name,
                hintContent: service.name
            }
        }));

        objectManager.removeAll();
        if (features.length > 0) {
            objectManager.add({
                type: 'FeatureCollection',
                features: features
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –ø–æ–¥ –º–µ—Ç–∫–∏
            const bounds = objectManager.getBounds();
            if (bounds) {
                map.setBounds(bounds, { checkZoomRange: true });
            }
        }
    }

    function applyFilters() {
        const verificationFilter = document.getElementById('verification-filter').value;
        const servicesFilter = document.getElementById('services-filter').value.toLowerCase();

        const filtered = allAutoservices.filter(service => {
            const matchesVerification = verificationFilter === 'all' || service.verification_color === verificationFilter;
            const matchesServices = service.services.toLowerCase().includes(servicesFilter);
            return matchesVerification && matchesServices;
        });

        displayAutoservices(filtered);
    }

    function resetFilters() {
        document.getElementById('verification-filter').value = 'all';
        document.getElementById('services-filter').value = '';
        displayAutoservices(allAutoservices);
    }

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function locateUser() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    userLocation = [position.coords.latitude, position.coords.longitude];
                    map.setCenter(userLocation, 15);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userPlacemark = new ymaps.Placemark(userLocation, {
                        balloonContent: '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'
                    }, {
                        preset: 'islands#greenDotIcon',
                        draggable: false
                    });
                    
                    map.geoObjects.add(userPlacemark);
                },
                error => {
                    console.log('Geolocation error:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        } else {
            alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é');
        }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π
    map.controls.add(new ymaps.control.GeolocationControl());
</script>
{% endblock %}